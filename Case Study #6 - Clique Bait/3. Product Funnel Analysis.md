# ðŸŽ£ Case Study #6 - Clique Bait
## ðŸ’» 3. Product Funnel Analysis

Using a single SQL query - create a new output table which has the following details:

* How many times was each product viewed?
* How many times was each product added to cart?
* How many times was each product added to a cart but not purchased (abandoned)?
* How many times was each product purchased?

Additionally, create another table which further aggregates the data for the above points but this time for each product category instead of individual products.

Use your 2 new output tables - answer the following questions:

1. Which product had the most views, cart adds and purchases?
2. Which product was most likely to be abandoned?
3. Which product had the highest view to purchase percentage?
4. What is the average conversion rate from view to cart add?
5. What is the average conversion rate from cart add to purchase?

```TSQL
--filter visit_id which has purchase event
WITH purchase_visit AS (
SELECT visit_id
FROM clique_bait.events e
WHERE event_type=3),

--pull out all the info for the visit_id which has a purchase event
purchased_item AS (
SELECT *
FROM clique_bait.events e
RIGHT JOIN purchase_visit pv ON e.visit_id=pv.visit_id
ORDER BY e.visit_id, sequence_number),
	
--determine purchased products
purchased_product AS(	
SELECT 
  e.page_id, 
  page_name, 
  SUM(CASE WHEN event_type=2 THEN 1 ELSE 0 END) purchase_count
FROM purchased_item e
LEFT JOIN clique_bait.page_hierarchy ph ON e.page_id=ph.page_id
WHERE e.page_id NOT IN (1,2,12,13)
GROUP BY e.page_id, page_name),

--join tables, add view_count and added_to_cart_count columns
--I had to do this because if I try to do SUM(CASE WHEN e.event_type=3 THEN 1 ELSE 0 END) then it will return 0 because purchase event only occures on the confirmation page
view_add_purchase AS (
SELECT 
  e.page_id, 
  ph.page_name, 
  SUM(CASE WHEN e.event_type=1 THEN 1 ELSE 0 END) view_count,
  SUM(CASE WHEN e.event_type=2 THEN 1 ELSE 0 END) added_to_cart_count,
  pp.purchase_count
FROM clique_bait.events e
LEFT JOIN clique_bait.page_hierarchy ph ON e.page_id=ph.page_id
LEFT JOIN purchased_product pp ON ph.page_name=pp.page_name
WHERE e.page_id NOT IN (1,2,12,13)
GROUP BY e.page_id, ph.page_name, pp.purchase_count)

--added_to_cart_count - purchase_count = abondon_count
SELECT 
	page_name, 
	view_count, 
	added_to_cart_count,
	added_to_cart_count-purchase_count abondon_count,
	purchase_count
FROM view_add_purchase;
```

| page_name      | view_count | added_to_cart_count | abondon_count | purchase_count |
|----------------|------------|---------------------|---------------|----------------|
| Oyster        | 	1568       | 943                 | 217           | 726            |
| Crab           | 	1564       | 949                 | 230           | 719            |
| Black Truffle  | 	1469       | 924                 | 217           | 707            |
| Tuna           | 	1515       | 931                 | 234           | 697            |
| Lobster        | 	1547       | 968                 | 214           | 754            |
| Salmon         | 	1559       | 938                 | 227           | 711            |
| Russian Caviar | 	1563       | 946                 | 249           | 697            |
| Abalone        | 	1525       | 932                 | 233           | 699            |
| Kingfish       | 	1559       | 920                 | 213           | 707            |












```TSQL
WITH cte AS(
SELECT
  user_id,
  visit_id,
  MIN(event_time) visit_start_time,
  SUM(CASE WHEN event_type=1 THEN 1 ELSE 0 END) page_views,
  SUM(CASE WHEN event_type=2 THEN 1 ELSE 0 END) cart_adds,
  STRING_AGG(event_type::TEXT, ', ') action_n,
  SUM(CASE WHEN event_type=4 THEN 1 ELSE 0 END) impression,
  SUM(CASE WHEN event_type=5 THEN 1 ELSE 0 END) click
FROM clique_bait.events e
LEFT JOIN clique_bait.users u ON e.cookie_id=u.cookie_id
GROUP BY visit_id, user_id),

cte2 AS (
SELECT
  visit_id,
  e.page_id,
  page_name,
  sequence_number
FROM clique_bait.events e
LEFT JOIN clique_bait.page_hierarchy ph ON e.page_id=ph.page_id
WHERE e.page_id NOT IN (1,2,12,13) AND event_type = 2
GROUP BY visit_id, e.page_id, page_name, sequence_number)

SELECT
  cte2.visit_id,
  (CASE WHEN cte.cart_adds != 0 THEN STRING_AGG(page_name::TEXT, ', ' ORDER BY sequence_number)
   ELSE NULL END) inside_cart
INTO inside_cart_tbl
FROM cte2
LEFT JOIN cte ON cte2.visit_id=cte.visit_id
GROUP BY cte2.visit_id, cte.cart_adds;

-------------

WITH cte AS(
SELECT
  user_id,
  visit_id,
  MIN(event_time) visit_start_time,
  SUM(CASE WHEN event_type=1 THEN 1 ELSE 0 END) page_views,
  SUM(CASE WHEN event_type=2 THEN 1 ELSE 0 END) cart_adds,
  STRING_AGG(event_type::TEXT, ', ') action_n,
  SUM(CASE WHEN event_type=4 THEN 1 ELSE 0 END) impression,
  SUM(CASE WHEN event_type=5 THEN 1 ELSE 0 END) click
FROM clique_bait.events e
LEFT JOIN clique_bait.users u ON e.cookie_id=u.cookie_id
GROUP BY visit_id, user_id)

SELECT
  user_id,
  cte.visit_id,
  visit_start_time,
  page_views,
  cart_adds,
  (CASE WHEN action_n ~ '3' THEN 1 ELSE 0 END) purchase,
  (CASE WHEN visit_start_time BETWEEN '2020-01-01' AND '2020-01-14' THEN 'BOGOF - Fishing For Compliments'
        WHEN visit_start_time BETWEEN '2020-01-15' AND '2020-01-28' THEN '25% Off - Living The Lux Life'
        WHEN visit_start_time BETWEEN '2020-02-01' AND '2020-03-31' THEN 'Half Off - Treat Your Shellf(ish)'
   ELSE NULL END) campaign_name,
  impression,
  click,
  inside_cart AS cart_products
INTO campaingns_analysis
FROM cte
LEFT JOIN inside_cart_tbl ict ON cte.visit_id=ict.visit_id;

SELECT *
FROM campaingns_analysis
LIMIT 20;
```

First 5 rows.

| user_id | visit_id | visit_start_time           | page_views | cart_adds | purchase | campaign_name                     | impression | click | cart_products                                                |
|---------|----------|----------------------------|------------|-----------|----------|-----------------------------------|------------|-------|--------------------------------------------------------------|
| 155	     | 001597   | 2020-02-17 00:21:45.295141 | 	10         | 6         | 1	        | Half Off - Treat Your Shellf(ish) | 	1          | 1	     | Salmon, Russian Caviar, Black Truffle, Lobster, Crab, Oyster |
| 243	     | 002809   | 2020-03-13 17:49:55.45987  | 	4          | 0         | 0	        | Half Off - Treat Your Shellf(ish) | 	0          | 0     |   null                                                           |
| 78	      | 0048b2   | 2020-02-10 02:59:51.335452 | 	6          | 4         | 0	        | Half Off - Treat Your Shellf(ish) | 	0          | 0	     | Kingfish, Russian Caviar, Abalone, Lobster                   |
| 228	     | 004aaf   | 2020-03-18 13:23:07.97394  | 	6          | 2         | 1	        | Half Off - Treat Your Shellf(ish) | 	0          | 0	     | Tuna, Lobster                                                |
| 237	     | 005fe7   | 2020-04-02 18:14:08.257711 | 	9          | 4         | 1        | null                              | 0          | 0	     | Kingfish, Black Truffle, Crab, Oyster                        |



---

### 2. How many cookies does each user have on average?

```TSQL
WITH cte AS (
  SELECT COUNT(cookie_id) cookie_count
  FROM clique_bait.users
  GROUP BY user_id)
  
SELECT ROUND(AVG(cookie_count),3) avg_cookie_count
FROM cte;
```

| avg_cookie_count  | 
|------------|
| 3.564 |

---

### 3. What is the unique number of visits by all users per month?

```TSQL
WITH cte AS (
  SELECT 
    EXTRACT(MONTH FROM event_time) month_n,
    COUNT(DISTINCT visit_id) visit_count
  FROM clique_bait.events
  GROUP BY EXTRACT(MONTH FROM event_time))
  
SELECT month_n, SUM(visit_count) visit_count
FROM cte
GROUP BY month_n; 
```

| month_n  | visit_count  |
|------------|------------|
| 1 | 876 |
| 2 | 1488 |
| 3 | 916 |
| 4 | 248 |
| 5 | 36 |

---

### 4. What is the number of events for each event type?

```TSQL
SELECT 
  e.event_type, 
  event_name,
  COUNT(e.event_type) event_count
FROM clique_bait.events e
JOIN clique_bait.event_identifier ei ON e.event_type=ei.event_type
GROUP BY 1,2
ORDER BY 1;
```

| event_type | event_name    | event_count |
|------------|---------------|-------------|
| 1	          | Page View     | 	20928       |
| 2	          | Add to Cart   | 	8451        |
| 3	          | Purchase      | 	1777        |
| 4	          | Ad Impression | 	876         |
| 5	          | Ad Click      | 	702         |

---

### 5. What is the percentage of visits which have a purchase event?

```TSQL
WITH cte AS (
SELECT CAST(COUNT(event_type)AS NUMERIC) purchase_count
FROM clique_bait.events
WHERE event_type=3)

SELECT ROUND(cte.purchase_count/CAST(COUNT(e.event_type)AS NUMERIC)*100,2) purchase_percentage
FROM cte, clique_bait.events e
GROUP BY purchase_count;
```

| purchase_percentage | 
|--------|
| 5.43 | 	

---

### 6. What is the percentage of visits which view the checkout page but do not have a purchase event?

```TSQL
WITH cte AS (
SELECT *, LEAD(event_type) OVER(PARTITION BY visit_id ORDER BY event_time) lead_event
FROM clique_bait.events
WHERE page_id=12 OR event_type=3),

cte2 AS (
SELECT 
  CAST(SUM(CASE WHEN (e.page_id=12 AND e.event_type=3) THEN 1 
                WHEN (e.page_id=12 AND lead_event=3) THEN 1 
           ELSE 0 END)AS NUMERIC) count_checkout_purchase,
  
  CAST(SUM(CASE WHEN (e.page_id=12 AND lead_event is null) THEN 1 
           ELSE 0 END)AS NUMERIC) count_checkout_no_purchase,
  
  CAST(SUM(CASE WHEN e.page_id=12 THEN 1
           ELSE 0 END)AS NUMERIC) total
FROM cte e)


SELECT
  ROUND(count_checkout_purchase/total*100,1) checkout_purchase_percentage,
  ROUND(count_checkout_no_purchase/total*100,1) checkout_no_purchase_percentage
FROM cte2;
```

| checkout_purchase_percentage | checkout_no_purchase_percentage | 
|---------------|--------------|
| 84.5          | 15.5            | 

---

### 7. What are the top 3 pages by number of views?

```TSQL
SELECT e.page_id, page_name, COUNT(event_type) view_count
FROM clique_bait.events e
LEFT JOIN clique_bait.page_hierarchy ph ON e.page_id=ph.page_id
WHERE event_type=1
GROUP BY e.page_id, page_name
ORDER BY 3 DESC
LIMIT 3;
```

| page_id | page_name | view_count | 
|---------------|--------------|-------------------|
| 2      | All Products            | 3174             | 
| 12          | Checkout            | 2103             | 
| 1          | Home Page            | 1782             | 

---

### 8. What is the number of views and cart adds for each product category?

```TSQL
--page view ranking
SELECT e.page_id, page_name, COUNT(event_type) view_count
FROM clique_bait.events e
LEFT JOIN clique_bait.page_hierarchy ph ON e.page_id=ph.page_id
WHERE event_type=1 AND e.page_id NOT IN (1,2,12,13)
GROUP BY e.page_id, page_name
ORDER BY 3 DESC;
```

First 5 rows.

| page_id | page_name      | view_count |
|---------|----------------|------------|
| 11	      | Oyster         | 	1568       |
| 10	      | Crab           | 	1564       |
| 6	       | Russian Caviar | 	1563       |
| 3	       | Salmon         | 	1559       |
| 4	       | Kingfish       | 	1559       |


```TSQL
--cart adds ranking
SELECT e.page_id, page_name, COUNT(event_type) cart_adds_count
FROM clique_bait.events e
LEFT JOIN clique_bait.page_hierarchy ph ON e.page_id=ph.page_id
WHERE event_type=2 AND e.page_id NOT IN (1,2,12,13)
GROUP BY e.page_id, page_name
ORDER BY 3 DESC;
```

First 5 rows.

| page_id | page_name      | cart_adds_count |
|---------|----------------|-----------------|
| 9	       | Lobster        | 	968             |
| 10	      | Crab           | 	949             |
| 6	       | Russian Caviar | 	946             |
| 11	      | Oyster         | 	943             |
| 3	       | Salmon         | 	938             |

---

### 9. What are the top 3 products by purchases?

```TSQL
WITH cte AS (
SELECT visit_id, cookie_id, e.page_id, page_name, e.event_type, event_name, sequence_number sq_n, event_time
FROM clique_bait.events e
LEFT JOIN clique_bait.page_hierarchy ph ON e.page_id=ph.page_id
LEFT JOIN clique_bait.event_identifier ei ON e.event_type=ei.event_type
WHERE e.page_id NOT IN (1,2) AND e.event_type IN (2,3)
ORDER BY 1, 7),

cte2 AS(
SELECT 
  visit_id, 
  cookie_id, 
  STRING_AGG(page_id::TEXT, ', ') in_cart_id, 
  STRING_AGG(event_type::TEXT, ', ') action_n
FROM cte
GROUP BY 1,2),

cte3 AS(
SELECT *
FROM cte2
WHERE action_n !~ '3'),

cte4 as (
SELECT visit_id, cookie_id, CAST(UNNEST(string_to_array(in_cart_id, ', '))AS INT) page_id
FROM cte3)

SELECT page_name seafood, COUNT(cte4.page_id) purchase_count
FROM cte4
LEFT JOIN clique_bait.page_hierarchy ph ON cte4.page_id=ph.page_id
GROUP BY page_name
ORDER BY 2 DESC
LIMIT 3;
```

| seafood        | purchase_count |
|----------------|----------------|
| Russian Caviar | 	249            |
| Tuna           | 	234            |
| Abalone        | 	233            |
